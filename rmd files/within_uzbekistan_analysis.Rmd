---
title: "Uzbekistan Health Reforms: Within Uzbekistan Analysis"
author: Michelle Schultze
output: pdf_document
date: "2023-01-22"
---

```{r library-data, message=FALSE, warning=FALSE, include=FALSE}
install.packages("readxl", repos = "http://cran.us.r-project.org")
install.packages("tidyverse", repos = "http://cran.us.r-project.org")
install.packages("broom", repos = "http://cran.us.r-project.org")
install.packages("tidymodels", repos = "http://cran.us.r-project.org")
install.packages("ggplot2", repos = "http://cran.us.r-project.org")
install.packages("pls", repos = "http://cran.us.r-project.org")
install.packages("haven", repos = "http://cran.us.r-project.org")
install.packages("maps", repos = "http://cran.us.r-project.org")
install.packages("rgdal", repos = "http://cran.us.r-project.org")
install.packages("maptools", repos = "http://cran.us.r-project.org")
install.packages("sf", repos = "http://cran.us.r-project.org")
install.packages("terra", repos = "http://cran.us.r-project.org")
install.packages("plm", repos = "http://cran.us.r-project.org")
install.packages("AER", repos = "http://cran.us.r-project.org")
install.packages("stargazer", repos = "http://cran.us.r-project.org")
install.packages("ISLR2", repos = "http://cran.us.r-project.org")
install.packages("leaps", repos = "http://cran.us.r-project.org")
install.packages("glmnet", repos = "http://cran.us.r-project.org")
install.packages("tmap", repos = "http://cran.us.r-project.org")
tinytex::install_tinytex()

library(readxl)
library(tidyverse)
library(broom)
library(tidymodels)
library(ggplot2)
library(pls)
library(haven)
library(maps)
library(rgdal)
library(maptools)
library(sf)
library(terra)
library(plm)
library(AER)
library(stargazer)
library(ISLR2)
library(leaps)
library(glmnet)
library(tmap)
library(tinytex)

uz_data <- read_csv("/Users/michelle/uzbek-healthcare/data/uzbekistan_data_tidy.csv")
nat_uz_data <- read_csv("/Users/michelle/uzbek-healthcare/data/national_uzbekistan_data_tidy.csv")
age_structure <- read_csv("/Users/michelle/uzbek-healthcare/data/uzbekistan_age_structure_2022.csv")

theme_bw()

map_1 <- readOGR( 
  dsn= paste0("/Users/michelle/uzbek-healthcare/data/uzbekistan_map") , 
  layer="gadm41_UZB_1",
  verbose=FALSE)

map_1@data$NAME_1
map_1@data$NAME_1 <- c("Andijan", "Bukhara", "Fergana"  ,  "Jizah"  ,     "Namangan"   , "Navoiy"      ,"Karakalpakstan", "Kashkadarya"     ,  "Samarkand"   ,  "Syrdarya"   ,  "Surkhandarya","Tashkent"    ,   "Tashkent city"  ,  "Khorezm")

```


**Doctors Per Capita**

```{r doc-map}
test <- data.frame(map_1@data$NAME_1)
test <- test %>%
  mutate(Region = map_1.data.NAME_1) %>% 
  merge(filter(uz_data, year == 2019), by = "Region", all = TRUE, sort = FALSE) %>%
  mutate(doctors_per_capita == as.numeric(doctors_per_capita)) %>%
  select(doctors_per_capita)

map_1@data$doctors_per_capita <- as.numeric(unlist(test))

library(RColorBrewer)
my_colors <- brewer.pal(9, "Blues") 
my_colors <- colorRampPalette(my_colors)(30)

class_of_country <- cut(test$doctors_per_capita, 30)
my_colors <- my_colors[as.numeric(class_of_country)]

plot(map_1 , col=my_colors, main = "Doctors per Capita, 2019")



## excluding the outlier, tashkent city

test <- data.frame(map_1@data$NAME_1)
test <- test %>%
  mutate(Region = map_1.data.NAME_1) %>% 
  merge(filter(uz_data, year == 2019), by = "Region", all = TRUE, sort = FALSE) %>%
  mutate(doctors_per_capita == as.numeric(doctors_per_capita)) %>%
  mutate(doctors_per_capita = ifelse(Region == "Tashkent city", NA, doctors_per_capita)) %>%
  select(doctors_per_capita)

map_1@data$doctors_per_capita <- as.numeric(unlist(test))

library(RColorBrewer)
my_colors <- brewer.pal(9, "Blues") 
my_colors <- colorRampPalette(my_colors)(30)

class_of_country <- cut(test$doctors_per_capita, 30)
my_colors <- my_colors[as.numeric(class_of_country)]

plot(map_1 , col=my_colors, main = "Doctors per Capita, 2019 (excl. Tashkent city)")

```

**Charts**

```{r doc-plots}
yrs <- uz_data %>%
  filter(doctors_per_capita != 0) %>%
  select(year) %>%
  slice(1, n()) 
yr_start <- yrs$year[1]
yr_end <- yrs$year[2]
  
  

## year range: 2002-2020 automatically stored for future use

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = year, y = doctors_per_capita, color = Region)) +
  geom_line() +
  labs(title = "Doctors Per Capita", 
       x = "Year", y = "Doctors Per Capita")

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = year, y = doctors_per_capita, color = Region)) +
  geom_line() +
  facet_wrap(~ Region) + 
  labs(title = "Doctors Per Capita", 
     x = "Year", y = "Doctors Per Capita") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# Exclude the outlier, Tashkent City
uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  filter(Region != "Tashkent city") %>%
  ggplot(aes(x = year, y = doctors_per_capita, color = Region)) +
  geom_line() +
  labs(title = "Doctors Per Capita", 
       x = "Year", y = "Doctors Per Capita",
       subtitle = "Omitting Tashkent City")

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  filter(Region != "Tashkent city") %>%
  ggplot(aes(x = year, y = doctors_per_capita, color = Region)) +
  geom_line() +
  facet_wrap(~ Region) + 
  labs(title = "Doctors Per Capita", 
       x = "Year", y = "Doctors Per Capita",
       subtitle = "Omitting Tashkent City") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))


```

```{r doc-boxplots}
# By Region

uz_data %>%
  ggplot(aes(x = Region, y = doctors_per_capita)) +
  geom_boxplot(aes(fill = Region), show.legend = FALSE) +
  labs(title = "Doctors Per Capita", 
     x = "Region", y = "Doctors Per Capita") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

uz_data %>%
  filter(Region != "Tashkent city") %>%
  ggplot(aes(x = Region, y = doctors_per_capita)) +
  geom_boxplot(aes(fill = Region), show.legend = FALSE) +
  labs(title = "Doctors Per Capita", subtitle = "Omitting Tashkent City",
     x = "Region", y = "Doctors Per Capita") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# By year

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = as.character(year), y = doctors_per_capita)) +
  geom_boxplot() +
  labs(title = "Doctors Per Capita", subtitle = "by year",
     x = "Year", y = "Doctors Per Capita") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  filter(Region != "Tashkent city") %>%
  ggplot(aes(x = as.character(year), y = doctors_per_capita)) +
  geom_boxplot() +
  labs(title = "Doctors Per Capita", subtitle = "by year, omitting Tashkent City",
     x = "Year", y = "Doctors Per Capita") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

```{r docs-histo}
uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = doctors_per_capita)) +
  geom_histogram(bins = 10) +
  facet_wrap(~ year) +
  labs(title = "Doctors Per Capita", x = "Doctors per Capita", 
       y = "Number of Regions") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# Exclude the outlier, Tashkent City

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  filter(Region != "Tashkent city") %>%
  ggplot(aes(x = doctors_per_capita)) +
  geom_histogram(bins = 10) +
  facet_wrap(~ year) +
  labs(title = "Doctors Per Capita", x = "Doctors per Capita", 
       y = "Number of Regions", subtitle = "Omitting Tashkent City") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```


**Looking at the national level**

```{r docs-uz}
nat_uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = year, y = doctors_per_capita)) +
  geom_line() + geom_point() +
  labs(title = "Doctors per Capita", subtitle = "Uzbekistan national level", 
       x = "Year", y = "Doctors Per Capita")

nat_uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = year, y = doctors_per_capita)) +
  geom_line(linewidth=1.25) +
  geom_line(data = filter(uz_data, Region == "Tashkent city" | Region == "Navoiy" | Region == "Jizah" | Region == "Syrdarya" | Region == "Tashkent"), aes(x = year, y = doctors_per_capita, color = Region)) +
  labs(title = "Doctors per Capita", subtitle = "Uzbekistan national level", x = "Year", y = "Doctors per Capita")
```


**Descriptives**

Jizah and Surkhandarya were the only regions to have less than or equal to 1.7 doctors per 1000 people (global average) in 2019.
source: https://data.worldbank.org/indicator/SH.MED.PHYS.ZS?end=2019&start=1963 

```{r glob-docs}
uz_data %>%
  filter(doctors_per_capita <= 17,
         year == 2019) %>%
  select(Region, year, doctors_per_capita)
```

Doctors per capita in Uzbekistan in 2002 was 31.9 doctors per 10000 people. Two regions exhibited more than the national average for doctors per capita in 2002.

```{r uz-doc-2002}
uz_doc_2002 <- nat_uz_data %>%
  filter(year == 2002) %>%
  select(doctors_per_capita)
uz_doc_2002 <- uz_doc_2002$doctors_per_capita
uz_doc_2002

uz_data %>%
  filter(doctors_per_capita > uz_doc_2002,
         year == 2002) %>%
  select(Region, year, doctors_per_capita)
```

Doctors per capita in Uzbekistan in 2020 was 27 doctors per 10000 people. Four regions had over than the national average for doctors per capita in 2020.

```{r uz-doc-2020}
uz_doc_2020 <- nat_uz_data %>%
  filter(year == 2020) %>%
  select(doctors_per_capita)
uz_doc_2020 <- uz_doc_2020$doctors_per_capita
uz_doc_2020

uz_data %>%
  filter(doctors_per_capita > uz_doc_2020,
         year == 2020) %>%
  select(Region, year, doctors_per_capita)
```

Simple regressions 

```{r doc-regressions}
nat_uz_data %>%
  ggplot(aes(x=year,y=doctors_per_capita)) +
  geom_smooth(method = "lm") + 
  geom_line()
uz_doctorsmodel <- linear_reg() %>%
  set_engine("lm") %>%
  fit(doctors_per_capita ~ year, data = nat_uz_data)
tidy(uz_doctorsmodel)
glance(uz_doctorsmodel)$p.value < 0.01

uz_data %>%
  filter(Region == "Tashkent city") %>%
  ggplot(aes(x=year,y=doctors_per_capita)) +
  geom_smooth(method = "lm") + 
  geom_line()
doctorsmodel <- linear_reg() %>%
  set_engine("lm") %>%
  fit(doctors_per_capita ~ year, data = filter(uz_data, Region == "Tashkent city"))
tidy(doctorsmodel)
glance(doctorsmodel)$p.value < 0.01

#remove likely error

uz_data %>%
  filter(Region == "Tashkent city", doctors_per_capita >= 60) %>%
  ggplot(aes(x=year,y=doctors_per_capita)) +
  geom_smooth(method = "lm") + 
  geom_line()
doctorsmodel <- linear_reg() %>%
  set_engine("lm") %>%
  fit(doctors_per_capita ~ year, data = filter(uz_data, Region == "Tashkent city"))
tidy(doctorsmodel)
glance(doctorsmodel)$p.value < 0.01
```

We have evidence to support that doctors per capita have decreased by approximately 0.24 doctors per 10000 population each year in Uzbekistan. Even once removing the likely error in our data, we do not have evidence to support a linear relationship between doctors per capita and year during this time period in Tashkent City.




**Fertility Rates**

```{r fert-map}
test <- data.frame(map_1@data$NAME_1)
test <- test %>%
  mutate(Region = map_1.data.NAME_1) %>% 
  merge(filter(uz_data, year == 2019), by = "Region", all = TRUE, sort = FALSE) %>%
  mutate(fert_rate == as.numeric(fert_rate)) %>%
  select(fert_rate)

map_1@data$fert_rate <- as.numeric(unlist(test))

library(RColorBrewer)
my_colors <- brewer.pal(9, "Greens") 
my_colors <- colorRampPalette(my_colors)(30)

class_of_country <- cut(test$fert_rate, 30)
my_colors <- my_colors[as.numeric(class_of_country)]

plot(map_1 , col=my_colors, main = "Fertility rate, 2019")
```

**Charts**

```{r fert-plots}
yrs <- uz_data %>%
  filter(fert_rate != 0) %>%
  select(year) %>%
  slice(1, n()) 
yr_start <- yrs$year[1]
yr_end <- yrs$year[2]

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
ggplot(aes(x = year, y = fert_rate, color = Region)) +
  geom_line() +
  labs(title = "Fertility Rate", 
       x = "Year", y = "Fertility Rate")

## Note the trend for Tashkent city (I can highlight this if necessary)

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
ggplot(aes(x = year, y = fert_rate, color = Region)) +
  geom_line() +
  facet_wrap(~ Region) + 
  labs(title = "Fertility Rate", 
     x = "Year", y = "Fertility Rate") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
ggplot(aes(x = year, y = fert_rate, color = Region)) +
  geom_smooth(method = "lm") +
  facet_wrap(~ Region) + 
  labs(title = "Fertility Rate", 
     x = "Year", y = "Fertility Rate") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

## very small standard error for each
## which regions tend to have downward trends? Karakalpakstan, Khorezm (West/SW regions) + Bukhara with no change (SW region)

```

```{r fert-boxplots}
# By Region

uz_data %>%
  ggplot(aes(x = Region, y = fert_rate)) +
  geom_boxplot() +
  labs(title = "Fertility Rate", 
     x = "Region", y = "Fertility Rate") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# By year

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = as.character(year), y = fert_rate)) +
  geom_boxplot() +
  labs(title = "Fertility Rate", subtitle = "by year",
     x = "Year", y = "Fertility Rate") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

## Note the greater spread in fertility rate as the years go on

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = fert_rate)) +
  geom_histogram(bins = 10) +
  facet_wrap(~ year) +
  labs(title = "Fertility Rate", x = "Fertility Rate", 
       y = "Number of Regions") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

## more of showing the increased spread
```



**Looking at the national level**

```{r fert-uz}
nat_uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = year, y = fert_rate)) +
  geom_point() +
  geom_line() +
  labs(title = "Fertility Rate", subtitle = "Uzbekistan national level", x = "Year", y = "Fertility Rate")

nat_uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
ggplot(aes(x = year, y = fert_rate)) +
  geom_line(size=1.25) +
  geom_line(data = filter(uz_data, Region == "Tashkent city" | Region == "Navoi" | Region == "Jizzakh" | Region == "Syrdarya" | Region == "Tashkent", year >= yr_start, year <= yr_end), aes(x = year, y = fert_rate, color = Region)) +
  labs(title = "Fertility Rate", subtitle = "Uzbekistan national level", x = "Year", y = "Fertility Rate")
```




**Descriptives**

The fertility rate in Uzbekistan in 2009 was 23.4. Eight regions exhibited more than the national average for the fertility rate in 2009.

```{r uz-fert-2009}
uz_fert_2009 <- nat_uz_data %>%
  filter(year == 2009) %>%
  select(fert_rate)
uz_fert_2009 <- uz_fert_2009$fert_rate
uz_fert_2009

uz_data %>%
  filter(fert_rate > uz_fert_2009,
         year == 2009) %>%
  select(Region, year, fert_rate)
```

The fertility rate in Uzbekistan in 2021 was 25.9. Eight regions had over than the national average for the fertility rate in 2021, with Khorezm/Karakalpakstan trading places with Navoi/Namagan.

```{r uz-fert-2021}
uz_fert_2021 <- nat_uz_data %>%
  filter(year == 2021) %>%
  select(fert_rate)
uz_fert_2021 <- uz_fert_2021$fert_rate
uz_fert_2021

uz_data %>%
  filter(fert_rate > uz_fert_2021,
         year == 2021) %>%
  select(Region, year, fert_rate)
```



**Simple regressions**

```{r fert-regressions}
nat_uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x=year,y=fert_rate)) +
  geom_smooth(method = "lm") + 
  geom_line() +
  labs(title = "Fertility rate over time, national level")
uz_fert_model <- linear_reg() %>%
  set_engine("lm") %>%
  fit(fert_rate ~ year, data = nat_uz_data)
tidy(uz_fert_model)
glance(uz_fert_model)$p.value < 0.01

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  filter(Region == "Tashkent city") %>%
  ggplot(aes(x=year,y=fert_rate)) +
  geom_smooth(method = "lm") + 
  geom_line() +
  labs(title = "Fertility rate over time in Tashkent city")
fert_model <- linear_reg() %>%
  set_engine("lm") %>%
  fit(fert_rate ~ year, data = filter(uz_data, Region == "Tashkent city"))
tidy(fert_model)
glance(fert_model)$p.value ##almost significant


uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  filter(Region == "Tashkent") %>%
  ggplot(aes(x=year,y=fert_rate)) +
  geom_smooth(method = "lm") + 
  geom_line() +
  labs(title = "Fertility rate over time in Tashkent oblast")
fert_model <- linear_reg() %>%
  set_engine("lm") %>%
  fit(fert_rate ~ year, data = filter(uz_data, Region == "Tashkent"))
tidy(fert_model)
glance(fert_model)$p.value < 0.01

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  filter(Region == "Syrdarya") %>%
  ggplot(aes(x=year,y=fert_rate)) +
  geom_smooth(method = "lm") + 
  geom_line() +
  labs(title = "Fertility rate over time in Syrdarya oblast")
fert_model <- linear_reg() %>%
  set_engine("lm") %>%
  fit(fert_rate ~ year, data = filter(uz_data, Region == "Syrdarya"))
tidy(fert_model)
glance(fert_model)$p.value < 0.01
```

We have evidence to support that the fertility rate in Uzbekistan has increased by approximately 0.25 units each year 2009-2021.
We also have moderately strong evidence to support a linear relationship between fertility rate and year during this time period in Tashkent City.
However, we don't have evidence to support such a relationship in Tashkent ot Syrdarya oblasts.







**Average Length of Stay**

```{r LOS-map}
test <- data.frame(map_1@data$NAME_1)
test <- test %>%
  mutate(Region = map_1.data.NAME_1) %>% 
  merge(filter(uz_data, year == 2019), by = "Region", all = TRUE, sort = FALSE) %>%
  mutate(LOS == as.numeric(LOS)) %>%
  select(LOS)

map_1@data$LOS <- as.numeric(unlist(test))

library(RColorBrewer)
my_colors <- brewer.pal(9, "Purples") 
my_colors <- colorRampPalette(my_colors)(30)

class_of_country <- cut(test$LOS, 30)
my_colors <- my_colors[as.numeric(class_of_country)]

plot(map_1 , col=my_colors, main = "Avg. Length of Stay, 2019")

```



Charts

```{r LOS-plots}
yrs <- uz_data %>%
  filter(LOS != 0) %>%
  select(year) %>%
  slice(1, n()) 
yr_start <- yrs$year[1]
yr_end <- yrs$year[2]

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
ggplot(aes(x = year, y = LOS, color = Region)) +
  geom_line() +
  labs(title = "Average Length of Stay", 
       x = "Year", y = "Average Length of Stay (days)")

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
ggplot(aes(x = year, y = LOS, color = Region)) +
  geom_line() +
  facet_wrap(~ Region) + 
  labs(title = "Average Length of Stay", 
     x = "Year", y = "Average Length of Stay (days)") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

```{r LOS-boxplots}
# By Region

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = Region, y = LOS)) +
  geom_boxplot() +
  labs(title = "Average Length of Stay", 
     x = "Region", y = "Average Length of Stay (days)") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

# By year

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = as.character(year), y = LOS)) +
  geom_boxplot() +
  labs(title = "Average Length of Stay", subtitle = "by year",
     x = "Year", y = "Average Length of Stay (days)") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

```{r LOS-histo}
uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = LOS)) +
  geom_histogram(bins = 10) +
  facet_wrap(~ year) +
  labs(title = "Average Length of Stay", x = "Average Length of Stay (days)", 
       y = "Number of Regions") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

Simple regressions 

```{r LOS-regressions}
uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  filter(Region == "Tashkent city") %>%
  ggplot(aes(x=year,y=LOS)) +
  geom_smooth(method = "lm") + 
  geom_line() +
  labs(title = "Tashkent City: Average Length of Stay")
LOS_model <- linear_reg() %>%
  set_engine("lm") %>%
  fit(LOS ~ year, data = filter(uz_data, Region == "Tashkent city"))
tidy(LOS_model)
glance(LOS_model)$p.value < 0.01

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  filter(Region == "Navoiy") %>%
  ggplot(aes(x=year,y=LOS)) +
  geom_smooth(method = "lm") + 
  geom_line() +
  labs(title = "Navoiy: Average Length of Stay")
LOS_model <- linear_reg() %>%
  set_engine("lm") %>%
  fit(LOS ~ year, data = filter(uz_data, Region == "Navoiy"))
tidy(LOS_model)
glance(LOS_model)$p.value < 0.01

uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  filter(Region == "Syrdarya") %>%
  ggplot(aes(x=year,y=LOS)) +
  geom_smooth(method = "lm") + 
  geom_line() +
  labs(title = "Syrdarya: Average Length of Stay")
LOS_model <- linear_reg() %>%
  set_engine("lm") %>%
  fit(LOS ~ year, data = filter(uz_data, Region == "Syrdarya"))
tidy(LOS_model)
glance(LOS_model)$p.value < 0.01


uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x=year,y=LOS)) +
  geom_smooth(method = "lm", aes(color = Region), se = FALSE) + 
  labs(title = "Syrdarya: Average Length of Stay")
LOS_model <- linear_reg() %>%
  set_engine("lm") %>%
  fit(LOS ~ year, data = uz_data)
tidy(LOS_model)
glance(LOS_model)$p.value < 0.01
```

We have evidence to support that average length of hospital stay per capita decreases by approximately -0.38 days per year in Tashkent City from 2000-2021, -0.32 days per year in Navoiy, -0.35 days per year in Syrdarya, and so on.




**Population analysis**

```{r pop-map}
test <- data.frame(map_1@data$NAME_1)
test <- test %>%
  mutate(Region = map_1.data.NAME_1) %>% 
  merge(filter(uz_data, year == 2019), by = "Region", all = TRUE, sort = FALSE) %>%
  mutate(pop == as.numeric(pop)) %>%
  select(pop)

map_1@data$pop <- as.numeric(unlist(test))

library(RColorBrewer)
my_colors <- brewer.pal(9, "Oranges") 
my_colors <- colorRampPalette(my_colors)(30)

class_of_country <- cut(test$pop, 30)
my_colors <- my_colors[as.numeric(class_of_country)]

plot(map_1 , col=my_colors, main = "Population, 2019")

```

```{r male-perc-map}
test <- data.frame(map_1@data$NAME_1)
test <- test %>%
  mutate(Region = map_1.data.NAME_1) %>% 
  merge(filter(uz_data, year == 2019), by = "Region", all = TRUE, sort = FALSE) %>%
  mutate(male_percent == as.numeric(male_percent)) %>%
  select(male_percent)

map_1@data$male_percent <- as.numeric(unlist(test))

library(RColorBrewer)
my_colors <- brewer.pal(9, "Oranges") 
my_colors <- colorRampPalette(my_colors)(30)

class_of_country <- cut(test$male_percent, 30)
my_colors <- my_colors[as.numeric(class_of_country)]

plot(map_1 , col=my_colors, main = "Male Percent of Population, 2019")

```

```{r age-bars}

age_structure %>%
  filter(age_range != "Population") %>%
ggplot(mapping = aes(x = reorder(Region, -pop_in_age), 
                     y = pop_in_age, 
                     fill = fct_relevel(age_range, 
                              c("0-2", "3-5", "6-7","8-15")))) + 
         geom_col(position = "fill", color = "black") +
  labs(title = "Population by Age Structure, 2022", y = "Population") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))


ggplot(data = filter(age_structure, 
                     age_range != "Population"), 
       mapping = aes(x = reorder(Region, -pop_in_age),
                     y = pop_in_age, 
                     fill = fct_relevel(age_range, 
                              c("0-2", "3-5", "6-7","8-15")))) + 
         geom_col(position = "stack", color = "black") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(title = "Population by Age Structure, 2022", y = "Population")

```

```{r urbanrural}

yrs <- uz_data %>%
  filter(pop_urban != 0) %>%
  select(year) %>%
  slice(1, n()) 
yr_start <- yrs$year[1]
yr_end <- yrs$year[2]


uz_data %>%
  filter(year == 2020) %>%
  group_by(Region) %>% 
  ggplot(mapping = aes(x=reorder(Region, urban_percent), y=urban_percent)) +
  geom_col(fill = "cadetblue4") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(title = "Urban percentage of population, 2020", y = "% Urban")

## filtering out likely data entry error
uz_data %>%
  filter(year >= yr_start, year <= yr_end, urban_percent <= 1) %>%
  ggplot(mapping = aes(x=year, y=urban_percent)) +
  geom_line() +
  facet_wrap(Region ~ .) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(title = "Urban percentage of population, 2020", y = "% Urban")


## excluding outlier, tashkent city
uz_data %>%
  filter(year >= yr_start, year <= yr_end, urban_percent <= 1,
         Region != "Tashkent city") %>%
  ggplot(mapping = aes(x=year, y=urban_percent)) +
  geom_line() +
  facet_wrap(Region ~ .) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(title = "Urban percentage of population, 2020", y = "% Urban")
```

```{r urbanrural-map}
test <- data.frame(map_1@data$NAME_1)
test <- test %>%
  mutate(Region = map_1.data.NAME_1) %>% 
  merge(filter(uz_data, year == 2020), by = "Region", all = TRUE, sort = FALSE) %>%
  mutate(urban_percent == as.numeric(urban_percent)) %>%
  select(urban_percent)

map_1@data$urban_percent <- as.numeric(unlist(test))

map_1@data %>% 
  ggplot( aes(x=as.numeric(urban_percent))) + 
    geom_histogram(bins=10, fill='#69b3a2', color='white')

library(RColorBrewer)
my_colors <- brewer.pal(9, "Reds") 
my_colors <- colorRampPalette(my_colors)(30)

class_of_country <- cut(map_1@data$urban_percent, 30)
my_colors <- my_colors[as.numeric(class_of_country)]

plot(map_1 , col=my_colors, main = "Urban population as percent of total")



## removing the outlier, Tashkent city

test <- data.frame(map_1@data$NAME_1)
test <- test %>%
  mutate(Region = map_1.data.NAME_1) %>% 
  merge(filter(uz_data, year == 2020), by = "Region", all = TRUE, sort = FALSE) %>%
  mutate(urban_percent == as.numeric(urban_percent)) %>%
  mutate(urban_percent = ifelse(Region == "Tashkent city", NA, urban_percent)) %>%
  select(urban_percent)

map_1@data$urban_percent <- as.numeric(unlist(test))

map_1@data %>% 
  ggplot( aes(x=as.numeric(urban_percent))) + 
    geom_histogram(bins=10, fill='#69b3a2', color='white')

library(RColorBrewer)
my_colors <- brewer.pal(9, "Reds") 
my_colors <- colorRampPalette(my_colors)(30)

class_of_country <- cut(map_1@data$urban_percent, 30)
my_colors <- my_colors[as.numeric(class_of_country)]

plot(map_1 , col=my_colors, main = "Urban percent (excl. Tashkent)")

```




*Infant Mortality Rate*

```{r IMR-map}
test <- data.frame(map_1@data$NAME_1)
test <- test %>%
  mutate(Region = map_1.data.NAME_1) %>% 
  merge(filter(uz_data, year == 2019), by = "Region", all = TRUE, sort = FALSE) %>%
  mutate(IMR_all == as.numeric(IMR_all)) %>%
  select(IMR_all)

map_1@data$IMR_all <- as.numeric(unlist(test))

map_1@data %>% 
  ggplot( aes(x=as.numeric(IMR_all))) + 
    geom_histogram(bins=10, fill='#69b3a2', color='white')

library(RColorBrewer)
my_colors <- brewer.pal(7, "Purples") 
my_colors <- colorRampPalette(my_colors)(30)

class_of_country <- cut(map_1@data$IMR_all, 30)
my_colors <- my_colors[as.numeric(class_of_country)]

plot(map_1 , col=my_colors, main = "Infant mortality rate")


```

```{r IMR}
yrs <- uz_data %>%
  filter(infant_mortality_count_all != 0) %>%
  select(year) %>%
  slice(1, n()) 
yr_start <- yrs$year[1]
yr_end <- yrs$year[2]


uz_data %>%
  na.omit() %>%
  group_by(Region) %>% 
  ggplot(mapping = aes(x=reorder(Region, -IMR_all), y=IMR_all)) +
  geom_bar(data = filter(uz_data, year == 2019), stat = "identity", linetype = "blank", fill = "orchid4") + 
  geom_bar(data = filter(uz_data, year == 2000), stat = "identity", linetype = "dashed", fill = NA, color = "black") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(title = "Infant Mortality in each Region, 2000 - 2019", y = "Infant morality")


```

```{r IMR-lines}



uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = year, y = IMR_all, color = Region)) +
  geom_line() +
  labs(title = "Infant Mortality Rate", 
       x = "Year", y = "Infant Mortality Rate")



nat_uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = year, y = IMR_all, color = Region)) +
  geom_line() +
  geom_smooth(method = "lm") +
  labs(title = "Infant Mortality Rate", 
       x = "Year", y = "Infant Mortality Rate") +
  scale_fill_discrete(name = "Infant Mortality Rate", labels = c("", "B", "C"))


```

```{r IMR-regressions}
nat_uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x=year,y=IMR_all)) +
  geom_smooth(method = "lm") + 
  geom_line() +
  labs(title = "Infant Mortality Rate, Republic of Uzbekistan")
IMR_model <- linear_reg() %>%
  set_engine("lm") %>%
  fit(IMR_all ~ year, data = nat_uz_data)
tidy(IMR_model)
glance(IMR_model)$p.value < 0.01


uz_data %>%
  filter(year >= yr_start, year <= yr_end, Region == "Tashkent city") %>%
  ggplot(aes(x=year,y=IMR_all)) +
  geom_smooth(method = "lm") + 
  geom_line() +
  labs(title = "Infant Mortality Rate, Tashkent city")
IMR_model <- linear_reg() %>%
  set_engine("lm") %>%
  fit(IMR_all ~ year, data = filter(uz_data, Region == "Tashkent city"))
tidy(IMR_model)
glance(IMR_model)$p.value < 0.01

```

We have evidence to support that the infant mortality rate decreases by 
approximately -0.45 births per year in Uzbekistan (and -0.46 in Tashkent City) 
from 2000-2020.




*Diseases*

*Tuberculosis*

```{r TB-map}
test <- data.frame(map_1@data$NAME_1)
test <- test %>%
  mutate(Region = map_1.data.NAME_1) %>% 
  merge(filter(uz_data, year == 2019), by = "Region", all = TRUE, sort = FALSE) %>%
  mutate(pc_TB == as.numeric(pc_TB)) %>%
  select(pc_TB)

map_1@data$pc_TB <- as.numeric(unlist(test))

map_1@data %>% 
  ggplot( aes(x=as.numeric(pc_TB))) + 
    geom_histogram(bins=10, fill='#69b3a2', color='white')

my_colors <- brewer.pal(7, "Oranges") 
my_colors <- colorRampPalette(my_colors)(30)

class_of_country <- cut(map_1@data$pc_TB, 30)
my_colors <- my_colors[as.numeric(class_of_country)]

plot(map_1 , col=my_colors, main = "Tuberculosis per capita, 2019")


```

Karakalpakstan seems to have the highest recorded TB rates.

```{r TB-col}
yrs <- uz_data %>%
  filter(pc_TB != 0) %>%
  select(year) %>%
  slice(1, n()) 
yr_start <- yrs$year[1]
yr_end <- yrs$year[2]


uz_data %>%
  group_by(Region) %>% 
  ggplot(mapping = aes(x=reorder(Region, -pc_TB), y=pc_TB)) +
  geom_bar(data = filter(uz_data, year == 2019), stat = "identity", linetype = "blank", fill = "lightcoral") + 
  geom_bar(data = filter(uz_data, year == 2000), stat = "identity", linetype = "dashed", fill = NA, color = "black") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(title = "TB rate in each Region, 2000 - 2019", y = "TB rate", x = "Region")


```

```{r TB-lines}



uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = year, y = pc_TB, color = Region)) +
  geom_line() +
  labs(title = "Tuberculosis rate per capita", 
       x = "Year", y = "Tuberculosis rate")



nat_uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = year, y = pc_TB, color = Region)) +
  geom_line() +
  geom_smooth(method = "lm") +
  labs(title = "Infant Mortality Rate", 
       x = "Year", y = "Infant Mortality Rate") 


```


```{r TB-regressions}
nat_uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x=year,y=pc_TB)) +
  geom_smooth(method = "lm") + 
  geom_line() +
  labs(title = "TB rate, Republic of Uzbekistan")
TB_model <- linear_reg() %>%
  set_engine("lm") %>%
  fit(pc_TB ~ year, data = nat_uz_data)
tidy(TB_model)
glance(TB_model)$p.value < 0.01

```
There is evidence to support that the TB rate decreases by 21.3 cases per 1000 people each year between 1991-2021 at the national level.
** these numbers feel wrong, but they are calculated to be per 1000 people

*Cancer*

```{r cancer-map}
test <- data.frame(map_1@data$NAME_1)
test <- test %>%
  mutate(Region = map_1.data.NAME_1) %>% 
  merge(filter(uz_data, year == 2019), by = "Region", all = TRUE, sort = FALSE) %>%
  mutate(pc_cancer == as.numeric(pc_cancer)) %>%
  select(pc_cancer)

map_1@data$pc_cancer <- as.numeric(unlist(test))

map_1@data %>% 
  ggplot( aes(x=as.numeric(pc_cancer))) + 
    geom_histogram(bins=10, fill='#69b3a2', color='white')

library(RColorBrewer)
my_colors <- brewer.pal(7, "Oranges") 
my_colors <- colorRampPalette(my_colors)(30)

class_of_country <- cut(map_1@data$pc_cancer, 30)
my_colors <- my_colors[as.numeric(class_of_country)]

plot(map_1 , col=my_colors, main = "Cancer per capita, 2019")



## excluding the outlier, Tashkent city

test <- data.frame(map_1@data$NAME_1)
test <- test %>%
  mutate(Region = map_1.data.NAME_1) %>% 
  merge(filter(uz_data, year == 2019), by = "Region", all = TRUE, sort = FALSE) %>%
  mutate(pc_cancer == as.numeric(pc_cancer)) %>%
  mutate(pc_cancer = ifelse(Region == "Tashkent city", NA, pc_cancer)) %>%
  select(pc_cancer)

map_1@data$pc_cancer <- as.numeric(unlist(test))

map_1@data %>% 
  ggplot( aes(x=as.numeric(pc_cancer))) + 
    geom_histogram(bins=10, fill='#69b3a2', color='white')

library(RColorBrewer)
my_colors <- brewer.pal(7, "Oranges") 
my_colors <- colorRampPalette(my_colors)(30)

class_of_country <- cut(map_1@data$pc_cancer, 30)
my_colors <- my_colors[as.numeric(class_of_country)]

plot(map_1 , col=my_colors, main = "Cancer per capita, 2019, (excl. Tashkent city)")

```

Andijan seems to have the highest cancer rates. The high recorded cancer rate 
in TB in Tashkent city is likely due to more robust diagnosis and treatment 
resources available in the city.

```{r cancer-lines}



uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = year, y = pc_cancer)) +
  geom_line() +
  facet_wrap(vars(Region)) +
  labs(title = "Cancer rate per capita", 
       x = "Year", y = "Cancer rate")



nat_uz_data %>%
  filter(year >= yr_start, year <= yr_end) %>%
  ggplot(aes(x = year, y = pc_cancer, color = Region)) +
  geom_line() +
  geom_smooth(method = "lm") +
  labs(title = "Cancer rate per capita", 
       x = "Year", y = "Cancer rate per capita")


```






*OUR REGIONS OF INTEREST: BORDER WITH KAZAKHSTAN*

```{r regions-map}
map_1@data  <- map_1@data %>%
  mutate(color = if_else(NAME_1 %in% c("Tashkent","Syrdarya","Jizah","Navoiy", "Karakalpakstan"), "lightblue", if_else(NAME_1 %in% c("Tashkent city"), "darkblue", "white"))) 
plot(map_1, col = map_1@data$color, main = "Border regions with Kazakhstan")
```
